<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>æ™ºèƒ½æ’­æ”¾åˆ—è¡¨å·¥å…·ç®±</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <!-- å›¾æ ‡åº“ -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <style>
    :root {
      --primary: #28a745;
      --primary-dark: #218838;
      --primary-light: #e8f5e8;
      --background: #f5f8fa;
      --card-bg: #fff;
      --radius: 20px;
      --shadow: 0 6px 32px #22bfa73d;
      --border: 1.5px solid #e5f2ee;
      --font-main: 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', Arial, sans-serif;
    }
    body {
      background: var(--background);
      font-family: var(--font-main);
      color: #1a3224;
      margin: 0;
      letter-spacing: .01em;
    }
    .main-wrap {
      max-width: 940px;
      margin: 56px auto 0 auto;
      padding: 0 18px;
    }
    .brand-header {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
      margin-bottom: 40px;
    }
    .brand-logo {
      width: 54px; height: 54px;
      background: linear-gradient(135deg, #24c6dc 0, #28a745 100%);
      color: #fff; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 2.2em; box-shadow: 0 3px 16px #28a74530;
    }
    .brand-title {
      font-size: 2.1em;
      font-weight: 800;
      background: linear-gradient(90deg, #24c6dc 10%, #28a745 90%);
      color: transparent;
      background-clip: text;
      -webkit-background-clip: text;
      letter-spacing: .08em;
    }
    .tab-header {
      display: flex;
      border-radius: var(--radius) var(--radius) 0 0;
      overflow: hidden;
      margin-bottom: 0;
      box-shadow: var(--shadow);
      background: #f8fcf7;
    }
    .tab-btn {
      flex: 1;
      font-size: 19px;
      padding: 18px 0 14px 0;
      background: #f7fdfb;
      color: var(--primary);
      font-weight: 700;
      border: none;
      cursor: pointer;
      transition: all .21s cubic-bezier(.4,0,.2,1);
      outline: none;
      border-bottom: 4px solid transparent;
      border-radius: 32px 32px 0 0;
      box-shadow: 0 2px 8px #24c6dc13;
      letter-spacing: 0.5px;
      position: relative;
    }
    .tab-btn .fa-solid { margin-right: 9px; }
    .tab-btn.active {
      background: linear-gradient(90deg,#24c6dc 0,#28a745 100%);
      color: #fff;
      border-bottom: 4px solid #1ea864;
      box-shadow: 0 8px 32px #24c6dc37;
    }
    .tab-btn:not(.active):hover {
      background: #eafbe6;
      color: #1fa764;
    }
    .tab-content {
      display: none;
      background: var(--card-bg);
      border-radius: 0 0 var(--radius) var(--radius);
      box-shadow: var(--shadow);
      padding: 38px 38px 34px 38px;
      margin-top: 0;
      min-height: 540px;
      animation: fadein .23s;
    }
    .tab-content.active { display: block; }
    @keyframes fadein { from {opacity: 0;transform: translateY(18px);} to {opacity: 1;transform: none;} }
    @media (max-width: 700px) {
      .main-wrap {padding: 0 1vw;}
      .tab-content {padding: 16px 3vw 18px 3vw;}
      .brand-title {font-size: 1.4em;}
      .brand-logo {width: 40px;height:40px;font-size: 1.4em;}
    }
    /* å¡ç‰‡/åˆ†å—æ ·å¼ */
    .info, .desc, .warning, .example, .upload-type-option, .url-examples {
      border-radius: var(--radius);
      box-shadow: 0 1px 10px #24c6dc10;
      background: var(--primary-light);
      border: none;
    }
    .info, .desc {background: #eafbe6;}
    .warning {background: #fff9d6; border-left: 4px solid #ffba00;}
    .example, .url-examples {background: #f8f9fa;}
    .upload-type-selector {display: flex; gap: 13px; margin-bottom: 22px;}
    .upload-type-option {
      flex: 1; padding: 15px 8px 13px 8px;
      background: #f7fdfb;
      border: var(--border);
      border-radius: var(--radius);
      cursor: pointer;
      user-select: none;
      transition: all .18s;
      text-align: center;
      font-size: 16px;
      color: var(--primary);
      min-width: 120px;
      margin-bottom: 0;
    }
    .upload-type-option i {font-size: 1.2em; margin-right: 6px;}
    .upload-type-option:hover, .upload-type-option.active {
      background: linear-gradient(90deg,#f4fffd 60%,#e8f5e8 100%);
      border: 2px solid var(--primary);
      color: #119946;
      font-weight: bold;
      box-shadow: 0 2px 10px #24c6dc15;
    }
    .upload-type-option input[type="radio"] {display: none;}
    .upload-section {
      display: none;
      padding: 20px 12px;
      border-radius: var(--radius);
      background: #f7fdfb;
      margin-bottom: 18px;
      border: var(--border);
      box-shadow: 0 1px 8px #24c6dc11;
    }
    .upload-section.active {display: block;}
    .form-group {margin-bottom: 22px;}
    label {display: block;margin-bottom: 7px;font-weight: bold;color: #399058;letter-spacing:0.15px;}
    input[type="file"], input[type="url"], textarea, select {
      width: 100%;padding: 12px 14px; border-radius: 11px;
      border: var(--border);
      background: #f7fdfb;
      font-size: 16px;
      margin-top: 3px;
      margin-bottom: 13px;
      transition: all .18s;
      box-shadow: 0 1px 6px #24c6dc10;
    }
    input[type="file"]:focus, input[type="url"]:focus, textarea:focus, select:focus {
      outline: none; border-color: var(--primary); background: #f1faf4;
    }
    button, .merge-container button {
      width: 100%;
      padding: 14px 0;
      background: linear-gradient(90deg,#24c6dc 0,#28a745 100%);
      color: #fff;
      border: none;
      border-radius: 16px;
      font-size: 18px;
      font-weight: 700;
      box-shadow: 0 2px 12px #24c6dc19;
      margin-top: 16px;
      letter-spacing: 0.7px;
      cursor: pointer;
      transition: .2s cubic-bezier(.6,0,.2,1);
      display: flex; align-items: center; justify-content: center; gap: 10px;
    }
    button:active, .merge-container button:active {
      transform: scale(0.98);
      box-shadow: 0 0 0 #fff0;
    }
    button:hover, .merge-container button:hover {
      filter: brightness(1.09) drop-shadow(0 0 8px #24c6dc3d);
    }
    pre {
      background: #f8f9fa;
      border-radius: 12px;
      border-left: 4px solid #28a745;
      padding: 16px 12px;
      font-size: 14px;
      margin-top: 11px;
      overflow-x: auto;
    }
    hr { border: none; border-top: 1px solid #e6efeb; margin: 24px 0;}
    .format-type {color: #24c6dc;}
    .highlight {background: #fff3cd; padding: 2px 6px; border-radius: 6px;}
    small {color: #9e9e9e;}
  </style>
</head>
<body>
<div class="main-wrap">
  <!-- é¡¶éƒ¨å“ç‰ŒLOGO+æ ‡é¢˜ -->
  <div class="brand-header">
    <div class="brand-logo"><i class="fa-solid fa-shuffle"></i></div>
    <span class="brand-title">æ™ºèƒ½æ’­æ”¾åˆ—è¡¨å·¥å…·ç®±</span>
  </div>
  <!-- Tabå¤´éƒ¨ -->
  <div class="tab-header">
    <button class="tab-btn active" data-tab="convert"><i class="fa-solid fa-repeat"></i>æ ¼å¼è½¬æ¢</button>
    <button class="tab-btn" data-tab="merge"><i class="fa-solid fa-layer-group"></i>åˆå¹¶å»é‡</button>
  </div>
  <!-- æ ¼å¼è½¬æ¢å†…å®¹ -->
  <div class="tab-content convert-container active" id="tab-convert">
    <div style="text-align: center; margin-bottom: 22px;">
      <span style="background-color: #ffeaa7; padding: 5px 16px; border-radius: 15px; font-size: 15px; color:#8b7411;">
        <i class="fa-solid fa-star"></i>
        æ”¯æŒåˆ†ç»„ã€æ‰¹é‡ã€è¿œç¨‹è®¢é˜…ã€å¤´ä¿¡æ¯åŒå‘ä¿ç•™
      </span>
    </div>
    <div class="info" style="margin-bottom: 24px;">
      <strong><i class="fa-solid fa-wand-magic-sparkles"></i> æ™ºèƒ½è½¬æ¢ç‰¹æ€§ï¼š</strong><br>
      â€¢ è‡ªåŠ¨è¯†åˆ«M3Uå’ŒTXTæ ¼å¼ï¼ˆå«/ä¸å«åˆ†ç»„å‡æ”¯æŒï¼‰<br>
      â€¢ <span class="highlight">å¤´ä¿¡æ¯/epg/è‡ªå®šä¹‰å†…å®¹å¯å®Œæ•´ä¿ç•™</span><br>
      â€¢ æ”¯æŒæœ¬åœ°å¤šæ–‡ä»¶ä¸Šä¼ å’Œè¿œç¨‹URLè®¢é˜…<br>
      â€¢ æ— éœ€æ‰‹åŠ¨é€‰æ‹©è½¬æ¢æ–¹å‘
    </div>
    <div class="upload-type-selector">
      <label class="upload-type-option active">
        <input type="radio" name="upload_type" value="file" checked>
        <i class="fa-solid fa-upload"></i>æœ¬åœ°æ‰¹é‡ä¸Šä¼ <br>
        <small>å¯å¤šé€‰M3U/TXTæ–‡ä»¶</small>
      </label>
      <label class="upload-type-option">
        <input type="radio" name="upload_type" value="url">
        <i class="fa-solid fa-link"></i>è¿œç¨‹è®¢é˜…é“¾æ¥<br>
        <small>è¾“å…¥åœ¨çº¿æ’­æ”¾åˆ—è¡¨URL</small>
      </label>
    </div>
    <div id="file_section" class="upload-section active">
      <div class="form-group">
        <label for="fileInput"><i class="fa-solid fa-file-arrow-up"></i>é€‰æ‹©æ–‡ä»¶ (M3U æˆ– TXTï¼Œå¯å¤šé€‰)ï¼š</label>
        <input type="file" id="fileInput" accept=".m3u,.txt,.m3u8" multiple>
      </div>
    </div>
    <div id="url_section" class="upload-section">
      <div class="form-group">
        <label for="remoteUrl"><i class="fa-solid fa-globe"></i>è¿œç¨‹è®¢é˜…é“¾æ¥ï¼š</label>
        <input type="url" id="remoteUrl" placeholder="https://example.com/playlist.m3u">
        <div class="url-examples">
          <strong>æ”¯æŒçš„é“¾æ¥æ ¼å¼ç¤ºä¾‹ï¼š</strong><br>
          â€¢ http://example.com/iptv.m3u<br>
          â€¢ https://example.com/channels.txt<br>
          â€¢ http://example.com/playlist.m3u8<br>
          â€¢ æ”¯æŒé‡å®šå‘å’ŒHTTPSé“¾æ¥
        </div>
      </div>
    </div>
    <button type="button" id="convertBtn"><i class="fa-solid fa-bolt"></i>æ™ºèƒ½è½¬æ¢</button>
    <div class="example">
      <strong>è½¬æ¢ç¤ºä¾‹ (æ”¯æŒåˆ†ç»„)ï¼š</strong><br><br>
      <span class="format-type">ğŸ“º M3Uæ ¼å¼ â†’ TXTæ ¼å¼:</span><br>
      <strong>è¾“å…¥:</strong><br>
      #EXTM3U<br>
      #EXTM3U x-tvg-url="https://epg.xx/epg.xml"<br>
      #EXTINF:-1 group-title="å«è§†",æ¹–å—å«è§†<br>
      http://example.com/hunan.m3u8<br><br>
      <strong>è¾“å‡º:</strong><br>
      <span class="highlight">#EXTM3U<br>#EXTM3U x-tvg-url="https://epg.xx/epg.xml"</span><br>
      <span class="highlight">å«è§†,#genre#</span><br>
      æ¹–å—å«è§†,http://example.com/hunan.m3u8<br><br>
      <hr style="margin: 20px 0; border: 1px solid #ddd;">
      <span class="format-type">ğŸ“ TXTæ ¼å¼ â†’ M3Uæ ¼å¼:</span><br>
      <strong>è¾“å…¥:</strong><br>
      <span class="highlight">#EXTM3U<br>#EXTM3U x-tvg-url="https://epg.xx/epg.xml"</span><br>
      <span class="highlight">å«è§†,#genre#</span><br>
      æ¹–å—å«è§†,http://example.com/hunan.m3u8<br><br>
      <strong>è¾“å‡º:</strong><br>
      #EXTM3U<br>
      #EXTM3U x-tvg-url="https://epg.xx/epg.xml"<br>
      #EXTINF:-1 tvg-id="æ¹–å—å«è§†" tvg-name="æ¹–å—å«è§†" tvg-logo="" group-title="å«è§†",æ¹–å—å«è§†<br>
      http://example.com/hunan.m3u8
    </div>
  </div>
  <!-- åˆå¹¶å»é‡å†…å®¹ -->
  <div class="tab-content merge-container" id="tab-merge">
    <div class="desc" style="margin-bottom:20px;">
      <b><i class="fa-solid fa-object-group"></i> åˆå¹¶å»é‡ç‰¹æ€§ï¼š</b>
      <ul>
        <li>æ”¯æŒæœ¬åœ°å¤šä¸ªM3U/TXTæ–‡ä»¶åˆå¹¶</li>
        <li>æ”¯æŒå¤šä¸ªè¿œç¨‹è®¢é˜…URLåˆå¹¶</li>
        <li>é¢‘é“åœ°å€ç›¸åŒçš„è‡ªåŠ¨å»é‡ï¼ˆä¿ç•™ç¬¬ä¸€ä¸ªï¼‰</li>
        <li>ä¿ç•™æ‰€æœ‰åˆ†ç»„ä¿¡æ¯ã€å¤´ä¿¡æ¯</li>
        <li>å¯é€‰è¾“å‡ºæ ¼å¼ï¼ˆM3Uæˆ–TXTï¼‰</li>
      </ul>
    </div>
    <div class="warning" style="margin-bottom:22px;">
      <i class="fa-solid fa-triangle-exclamation"></i>
      <b>å»é‡è¯´æ˜ï¼š</b>é¢‘é“URLç›¸åŒçš„ï¼Œåªä¿ç•™ç¬¬ä¸€ä¸ªé¢‘é“åˆ†ç»„/é¢‘é“ï¼Œå…¶ä½™ç›¸åŒåœ°å€é¢‘é“å°†è¢«å¿½ç•¥ã€‚
    </div>
    <div class="form-group">
      <label for="mergeFileInput"><i class="fa-solid fa-folder-open"></i>æœ¬åœ°æ–‡ä»¶ï¼ˆå¯å¤šé€‰M3U/TXTï¼Œæ”¯æŒæ‰¹é‡åˆå¹¶ï¼‰ï¼š</label>
      <input type="file" id="mergeFileInput" multiple accept=".m3u,.txt,.m3u8">
    </div>
    <div class="form-group">
      <label for="mergeUrlInput"><i class="fa-solid fa-link"></i>è¿œç¨‹è®¢é˜…é“¾æ¥ï¼ˆæ¯è¡Œä¸€ä¸ªURLï¼Œå¯å¤šè¡Œï¼‰ï¼š</label>
      <textarea id="mergeUrlInput" rows="3" placeholder="https://example.com/playlist.m3u"></textarea>
    </div>
    <div class="form-group">
      <label for="outputFormat"><i class="fa-solid fa-list"></i>è¾“å‡ºæ ¼å¼ï¼š</label>
      <select id="outputFormat">
        <option value="m3u">M3Uæ ¼å¼(.m3u)</option>
        <option value="txt">TXTæ ¼å¼(.txt)</option>
      </select>
    </div>
    <button id="mergeBtn"><i class="fa-solid fa-circle-nodes"></i>åˆå¹¶å¹¶å»é‡å¯¼å‡º</button>
    <div id="resultSection" style="display:none;">
      <b>åˆå¹¶å»é‡åé¢„è§ˆï¼š</b>
      <pre id="resultPreview"></pre>
    </div>
    <div class="example" style="margin-top:28px;">
      <b>åˆå¹¶å»é‡ç¤ºä¾‹ï¼š</b>
      <pre>
ğŸ”— å¤šæ–‡ä»¶åˆå¹¶ + æŒ‰URLå»é‡ï¼š
æ–‡ä»¶1 (playlist1.m3u):
#EXTM3U
#EXTINF:-1 group-title="å¤®è§†",CCTV1
http://example.com/cctv1.m3u8
#EXTINF:-1 group-title="å¤®è§†",CCTV2
http://example.com/cctv2.m3u8

æ–‡ä»¶2 (channels.txt):
å¤®è§†,#genre#
CCTV1é«˜æ¸…,http://example.com/cctv1.m3u8 â† ä¸æ–‡ä»¶1çš„CCTV1ç›¸åŒURL
CCTV3,http://example.com/cctv3.m3u8
å«è§†,#genre#
æ¹–å—å«è§†,http://example.com/hnws.m3u8

è¿œç¨‹URLè®¢é˜…:
http://yang-1989.eu.org/playlist.m3u
https://yang-1989.eu.org/channels.txt

åˆå¹¶åè¾“å‡º (TXTæ ¼å¼ï¼ŒæŒ‰URLå»é‡):
# åˆå¹¶å®Œæˆ - å…± 2 ä¸ªåˆ†ç»„ï¼Œ4 ä¸ªé¢‘é“ï¼ˆå·²æŒ‰URLå»é‡ï¼‰
å¤®è§†,#genre#
CCTV1,http://example.com/cctv1.m3u8 â† ä¿ç•™ç¬¬ä¸€ä¸ª
CCTV2,http://example.com/cctv2.m3u8
CCTV3,http://example.com/cctv3.m3u8
å«è§†,#genre#
æ¹–å—å«è§†,http://example.com/hnws.m3u8

âš ï¸ è¯´æ˜ï¼šCCTV1é«˜æ¸…è™½ç„¶åç§°ä¸åŒï¼Œä½†URLç›¸åŒï¼Œæ‰€ä»¥è¢«å»é‡äº†ï¼Œåªä¿ç•™äº†ç¬¬ä¸€ä¸ªé‡åˆ°çš„CCTV1
      </pre>
    </div>
  </div>
</div>
<script>
  // Tabåˆ‡æ¢
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.onclick = function() {
      document.querySelectorAll('.tab-btn').forEach(x => x.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(x => x.classList.remove('active'));
      this.classList.add('active');
      document.getElementById('tab-' + this.dataset.tab).classList.add('active');
    };
  });

  // m3uè½¬txt
  function m3u2txt(m3u) {
    let lines = m3u.split(/\r?\n/);
    let output = [];
    let customHeaders = [];
    let currentGroup = "";
    let firstGroupWritten = false;
    for(let i=0; i<lines.length; i++){
      let line = lines[i].trim();
      if(line.startsWith('#') && !line.startsWith('#EXTINF')) {
        customHeaders.push(line);
      } else if(line.startsWith('#EXTINF')){
        let groupMatch = line.match(/group-title="([^"]+)"/);
        let nameMatch = line.split(',').pop().trim();
        if(groupMatch){
          if(groupMatch[1] !== currentGroup){
            currentGroup = groupMatch[1];
            output.push(currentGroup+',#genre#');
          }
        } else {
          if(!firstGroupWritten){
            currentGroup = "æœªåˆ†ç»„";
            output.push(currentGroup+',#genre#');
            firstGroupWritten = true;
          }
        }
        output.push(nameMatch+',');
      } else if(line.startsWith('http')){
        let prev = output.pop();
        output.push(prev + line);
      }
    }
    return (customHeaders.length ? customHeaders.join('\n')+'\n' : '') + output.join('\n');
  }
  // txtè½¬m3uï¼ˆæ”¯æŒæ— åˆ†ç»„ï¼‰
  function txt2m3u(txt){
    let lines = txt.split(/\r?\n/);
    let output = [];
    let group = '';
    // ä¿ç•™å¤´éƒ¨æ‰€æœ‰ # è¡Œ
    for(let i=0;i<lines.length;i++){
      let line = lines[i].trim();
      if(line.startsWith('#')) output.push(line);
    }
    if(!output.length) output.push('#EXTM3U');
    for(let i=0; i<lines.length; i++){
      let line = lines[i].trim();
      if(!line || line.startsWith('#')) continue;
      if(line.endsWith(',#genre#')){
        group = line.replace(',#genre#','');
      } else {
        let arr = line.split(',');
        if(arr.length===2){
          let name = arr[0].trim();
          let url = arr[1].trim();
          output.push(`#EXTINF:-1 tvg-id="${name}" tvg-name="${name}" tvg-logo="" group-title="${group}",${name}`);
          output.push(url);
        }
      }
    }
    return output.join('\n');
  }
  // è‡ªåŠ¨è¯†åˆ«æ ¼å¼
  function autoConvert(content, filename) {
    if(/<html|<!DOCTYPE html/i.test(content)) return null;
    content = content.replace(/^\uFEFF/, '').trim();
    let lines = content.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
    if(lines.length === 0) return null;
    let first = lines[0];
    if(first.toUpperCase().startsWith('#EXTM3U')){
      let result = m3u2txt(lines.join('\n'));
      let outName = filename.replace(/\.(m3u8?|txt)$/i, '') + '.txt';
      if(result && result.trim().length > 0) {
        return {result, outName};
      } else {
        return null;
      }
    }
    // å…³é”®è¡¥ä¸ï¼šåªè¦æœ‰é¢‘é“å,URLå°±è¯†åˆ«ä¸ºTXT
    if (
      lines.some(l => l.endsWith(',#genre#')) ||
      lines.some(l => l.includes(',') && !l.startsWith('#'))
    ) {
      let result = txt2m3u(lines.join('\n'));
      let outName = filename.replace(/\.(m3u8?|txt)$/i, '') + '.m3u';
      if(result && result.trim().length > 0) {
        return {result, outName};
      } else {
        return null;
      }
    }
    return null;
  }
  function downloadStr(str, filename){
    let blob = new Blob([str], {type: 'text/plain'});
    let a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  }
  // ä¸Šä¼ æ–¹å¼åˆ‡æ¢
  const typeRadios = document.querySelectorAll('input[name="upload_type"]');
  const uploadSections = document.querySelectorAll('.upload-section');
  const typeOptions = document.querySelectorAll('.upload-type-option');
  typeRadios.forEach((radio, idx) => {
    radio.addEventListener('change', function() {
      typeOptions.forEach(option => option.classList.remove('active'));
      typeOptions[idx].classList.add('active');
      uploadSections.forEach(section => section.classList.remove('active'));
      document.getElementById(this.value + '_section').classList.add('active');
    });
  });
  typeOptions.forEach(option => {
    option.addEventListener('click', function() {
      let radio = this.querySelector('input[type="radio"]');
      if (radio) {
        radio.checked = true;
        radio.dispatchEvent(new Event('change'));
      }
    });
  });
  document.getElementById('convertBtn').onclick = async function(){
    const isFile = document.querySelector('input[name="upload_type"]:checked').value === 'file';
    if(isFile){
      const fileInput = document.getElementById('fileInput');
      if(!fileInput.files.length){
        alert('è¯·å…ˆé€‰æ‹©æ–‡ä»¶');
        return;
      }
      for(const file of fileInput.files){
        const content = await file.text();
        const conv = autoConvert(content, file.name);
        if(!conv){
          alert(`æ–‡ä»¶ ${file.name} æ ¼å¼æ— æ³•è¯†åˆ«ï¼Œè·³è¿‡`);
          continue;
        }
        downloadStr(conv.result, conv.outName);
      }
    } else {
      const url = document.getElementById('remoteUrl').value.trim();
      if(!url){
        alert('è¯·è¾“å…¥æœ‰æ•ˆçš„URL');
        return;
      }
      try{
        const resp = await fetch(url);
        if(!resp.ok) throw new Error("è·å–å¤±è´¥");
        const content = await resp.text();
        let fileName = url.split('/').pop().split('?')[0] || 'remote.m3u';
        const conv = autoConvert(content, fileName);
        if(!conv){
          alert("è¿œç¨‹å†…å®¹æ ¼å¼æ— æ³•è¯†åˆ«ï¼ï¼ˆå¦‚éœ€æ’æŸ¥è¯·è”ç³»å¼€å‘è€…ï¼‰");
          return;
        }
        downloadStr(conv.result, conv.outName);
      }catch(e){
        alert("è¿œç¨‹é“¾æ¥è·å–å¤±è´¥ï¼š" + e.message);
      }
    }
  };

  // ä»£ç 2ï¼ˆåˆå¹¶å»é‡ï¼‰é€»è¾‘ä¿æŒä¸å˜
  function parseM3UorTXT(raw) {
    let lines = raw.split(/\r?\n/).map(l=>l.trim());
    let headers = [], channels = [];
    let group = '', currentGroup = '', firstGroupWritten = false;
    for(let i=0;i<lines.length;i++){
      let line = lines[i];
      if(line.startsWith('#') && !line.startsWith('#EXTINF')) {
        headers.push(line);
      } else if(line.startsWith('#EXTINF')) {
        let groupMatch = line.match(/group-title="([^"]+)"/);
        let nameMatch = line.split(',').pop().trim();
        if(groupMatch){
          group = groupMatch[1];
        } else {
          if(!firstGroupWritten){ group = "æœªåˆ†ç»„"; firstGroupWritten = true;}
        }
        channels.push({name: nameMatch, group, extinf: line});
      } else if(line.startsWith('http')){
        if(channels.length && !channels[channels.length-1].url)
          channels[channels.length-1].url = line;
      } else if(line.endsWith(',#genre#')) {
        currentGroup = line.replace(',#genre#','');
      } else if(line && line.includes(',')) {
        let arr = line.split(',');
        if(arr.length==2){
          channels.push({name: arr[0].trim(), url: arr[1].trim(), group: currentGroup});
        }
      }
    }
    return {headers, channels};
  }
  function exportM3U(headers, channels) {
    let out = [];
    out.push(...headers.length ? headers : ['#EXTM3U']);
    channels.forEach(ch => {
      let g = ch.group || '';
      let extinf = ch.extinf || `#EXTINF:-1 tvg-id="${ch.name}" tvg-name="${ch.name}" tvg-logo="" group-title="${g}",${ch.name}`;
      out.push(extinf);
      out.push(ch.url);
    });
    return out.join('\n');
  }
  function exportTXT(headers, channels) {
    let out = [];
    let groupSet = new Set();
    channels.forEach(ch=>groupSet.add(ch.group));
    out.push(`# åˆå¹¶å®Œæˆ - å…± ${groupSet.size} ä¸ªåˆ†ç»„ï¼Œ${channels.length} ä¸ªé¢‘é“ï¼ˆå·²æŒ‰URLå»é‡ï¼‰`);
    out.push(...headers);
    let lastGroup = '';
    channels.forEach(ch => {
      let g = ch.group || '';
      if(g !== lastGroup) {
        out.push(g + ',#genre#');
        lastGroup = g;
      }
      out.push(ch.name + ',' + ch.url);
    });
    return out.join('\n');
  }
  function mergeAndDedup(allData) {
    let headers = allData.find(x=>x.headers.length)?.headers || ['#EXTM3U'];
    let urlSet = new Set(), channels = [];
    allData.forEach(({channels:chs})=>{
      chs.forEach(ch=>{
        if(ch.url && !urlSet.has(ch.url)){
          urlSet.add(ch.url);
          channels.push(ch);
        }
      });
    });
    return {headers, channels};
  }
  document.getElementById('mergeBtn').onclick = async function(){
    let fileInput = document.getElementById('mergeFileInput');
    let urlInput = document.getElementById('mergeUrlInput').value.trim();
    let outputFormat = document.getElementById('outputFormat').value;
    let allData = [];
    if(fileInput.files.length){
      for(let file of fileInput.files){
        let txt = await file.text();
        allData.push(parseM3UorTXT(txt));
      }
    }
    let urls = urlInput.split('\n').map(l=>l.trim()).filter(Boolean);
    for(let url of urls){
      try{
        let res = await fetch(url);
        if(res.ok){
          let txt = await res.text();
          allData.push(parseM3UorTXT(txt));
        }
      }catch(e){}
    }
    if(!allData.length){
      alert("è¯·è‡³å°‘ä¸Šä¼ ä¸€ä¸ªæ–‡ä»¶æˆ–è¾“å…¥ä¸€ä¸ªæœ‰æ•ˆè®¢é˜…URL");
      return;
    }
    let {headers, channels} = mergeAndDedup(allData);
    let result = (outputFormat === "m3u") ? exportM3U(headers, channels) : exportTXT(headers, channels);
    document.getElementById('resultSection').style.display = "block";
    document.getElementById('resultPreview').textContent = result.slice(0, 4000) + (result.length > 4000 ? '\n...(é¢„è§ˆå·²çœç•¥)...' : '');
    let blob = new Blob([result], {type: "text/plain"});
    let fname = "playlist_merged." + (outputFormat === "m3u" ? "m3u" : "txt");
    let a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = fname;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  }
</script>
</body>
</html>
